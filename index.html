<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ciacollor | Cat√°logo Inteligente</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&amp;display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* L√≥gica visual Admin/Cliente */
        body:not(.is-admin) .admin-only { display: none !important; }
        body.is-admin .client-only { display: none !important; }
        
        .product-card { transition: all 0.2s ease-in-out; }
        .product-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .product-card:active { transform: scale(0.98); }
        
        /* Ocultar flechas de input number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
    </style>
</head>
<body>

    <nav class="sticky top-0 z-50 bg-white border-b border-gray-200 px-4 py-3 shadow-sm">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-black text-blue-700 tracking-tighter">Ciacollor.</h1>
            <div class="flex gap-3">
                <select id="filterCategory" onchange="renderizar()" class="bg-gray-50 border border-gray-200 text-gray-700 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5">
                    <option value="Todos">Todas las Categor√≠as</option>
                    <option value="Emborrachada">üü¢ Emborrachada</option>
                    <option value="Al Agua">üíß Al Agua</option>
                    <option value="Sint√©tico">üõ¢Ô∏è Sint√©tico</option>
                </select>

                <input type="text" id="search" placeholder="Buscar..." class="bg-gray-100 rounded-lg px-3 py-1 text-sm focus:ring-2 focus:ring-blue-500 outline-none w-24 sm:w-48 transition-all">
                
                <button onclick="activarAdmin()" class="text-xs font-bold text-gray-400 hover:text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4">
        <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            </div>
        
        <div id="emptyState" class="hidden text-center py-10">
            <p class="text-gray-400">No se encontraron productos.</p>
        </div>
    </main>

    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg text-sm font-bold opacity-0 transition-opacity pointer-events-none z-50 flex items-center gap-2">
        <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
        Cambios guardados
    </div>

    <script>
        // 1. CONFIGURACI√ìN
        const SUPABASE_URL = 'https://grlwkaxsfvrvtuvlsvxv.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_8QnYD4TWUMFmiTo6Pd5_3w_yxmkgWCc'; // Reemplaza con tu Key real si esta cambia
        const WHATSAPP = '595987212934'; 

        // 2. DATA ENRIQUECIDA (He agregado descripciones clave para que el clasificador funcione)
        const catalogoBase = [
            {id: "2109", nombre: "Tinta Acr√≠lica Emborrachada Ciaflex 20kg", desc: "emborrachada ciaflex impermeabilizante", img: "https://images.tcdn.com.br/img/img_prod/1139809/tinta_acrilica_emborrachada_ciacollor_20kg_2109_1_9f894b5ff4fccf9f785014ad04918a0f.png", precio: 450000},
            {id: "2073", nombre: "Tinta Acr√≠lica Econ√¥mica Profissional 16lt", desc: "acrilica base agua economica", img: "https://images.tcdn.com.br/img/img_prod/1139809/tinta_acrilica_economica_profissional_fosco_ciacollor_16_l_2073_1_eb2c72aea432510f9efe1220835a3c46.png", precio: 280000},
            {id: "2111", nombre: "Tinta Emborrachada Ciaflex 3,6kg", desc: "emborrachada ciaflex", img: "https://images.tcdn.com.br/img/img_prod/1139809/tinta_acrilica_emborrachada_ciacollor_3_6kg_2111_1_c533bf16a35666853bb773e38f999f46.png", precio: 145000},
            {id: "2225", nombre: "Spray Uso Geral Met√°lico 400ml", desc: "spray sintetico solvente metal", img: "https://images.tcdn.com.br/img/img_prod/1139809/spray_uso_geral_metalico_ciacollor_400ml_2225_1_157b689817047b2e7e4d82f583a832ca.png", precio: 23000},
            {id: "2163", nombre: "Resina Eco Base √Ågua Ciacollor 18lt", desc: "resina base agua", img: "https://images.tcdn.com.br/img/img_prod/1139809/resina_eco_base_agua_ciacollor_18lt_2163_1_07cf08ae947eeb1503faa3b0f69ab87f.png", precio: 410000},
            {id: "2175", nombre: "Resina Multiuso Solvente 18lt", desc: "resina solvente sint√©tico", img: "https://images.tcdn.com.br/img/img_prod/1139809/resina_multiuso_base_solvente_ciacollor_18lt_2175_1_b6d4cc79df77d4508fb995b5e2248a46.png", precio: 679000},
            {id: "3637", nombre: "Fundo Sint√©tico Nivelador 3,6lt", desc: "fundo sintetico solvente", img: "https://images.tcdn.com.br/img/img_prod/1139809/fundo_sintetico_nivelador_ciacollor_3_6lt_3637_1_890dd18df9a8bb4990d75059b728af39.png", precio: 129000},
            {id: "2153", nombre: "Selador Emborrachado Ciaflex 18kg", desc: "selador emborrachada ciaflex", img: "https://images.tcdn.com.br/img/img_prod/1139809/selador_acrilico_emborrachado_ciaflex_ciacollor_18kg_2153_1_55e772bde97e5640dd2494a08dd9dac4.png", precio: 390000},
            {id: "2091", nombre: "Tinta Acr√≠lica Suprema Fosco 18lt", desc: "acrilica premium agua", img: "https://images.tcdn.com.br/img/img_prod/1139809/tinta_acrilica_suprema_fo_ac_ciacollor_18l_2091_1_cf73b58e272724f3ef3794244be3eb3b.png", precio: 303000},
            {id: "3883", nombre: "Esmalte Base √Ågua Brilhante 0,9lt", desc: "esmalte base agua", img: "https://images.tcdn.com.br/img/img_prod/1139809/esmalte_base_agua_brilhante_ciacollor_0_9lt_3883_1_5bdd93c5c31faa54b045860a3dfa23ee.png", precio: 52000},
            {id: "4108", nombre: "Impermeabilizante Ciabloq 18lt", desc: "impermeabilizante solvente ciabloq", img: "https://images.tcdn.com.br/img/img_prod/1139809/impermeabilizante_base_solvente_ciabloq_ciacollor_18lt_4108_1_1fe1e36cd8e7ddceb9e5ef62bcc38413.png", precio: 1203000},
            {id: "2077", nombre: "Tinta Acr√≠lica Performance Fosco 18lt", desc: "acrilica performance agua", img: "https://images.tcdn.com.br/img/img_prod/1139809/tinta_acrilica_performance_fosco_ciacollor_18_l_2077_1_e92923bc7a843f1b026f1a1bec844bd4.png", precio: 320000},
            {id: "4262", nombre: "Kit Esmalte Ep√≥xi 3x1 3,6Lt", desc: "epoxi solvente kit", img: "https://images.tcdn.com.br/img/img_prod/1139809/kit_esmalte_epoxi_poliamida_3x1_catalisador_ciacollor_3_6lt_4262_1_6b155e8c66545d9b8a8d2536f710d02e.png", precio: 311000},
            {id: "4065", nombre: "Efeito M√°rmore Base Branco 3,6lt", desc: "marmore efeito decorativo agua", img: "https://images.tcdn.com.br/img/img_prod/1139809/efeito_marmore_base_branco_ciacollor_3_6lt_4065_1_bbeb5a97e466c79e920ab629cbbad0bb.png", precio: 250000},
            {id: "2287", nombre: "Efeito Cimento Queimado 5,8kg", desc: "cimento queimado decorativo", img: "https://images.tcdn.com.br/img/img_prod/1139809/efeito_cimento_queimado_interior_ciacollor_5_8kg_2287_1_55d99d5f99ea8f6c4b2f80f9a20a1a60.png", precio: 208000}
        ];
        // Nota: He incluido una muestra representativa. El script clasificar√° cualquiera que agregues con su descripci√≥n correcta.

        // 3. FUNCI√ìN DE CLASIFICACI√ìN (El Cerebro)
        function classifyProduct(product) {
            const text = (product.nombre + ' ' + (product.desc || '')).toLowerCase();

            // L√≥gica de Prioridad
            if (text.includes('ciaflex') || text.includes('emborrachada')) {
                return { type: 'Emborrachada', bg: 'bg-purple-100', text: 'text-purple-700', border: 'border-purple-200' };
            }
            if (text.includes('solvente') || text.includes('sint√©tico') || text.includes('sintetico') || text.includes('epoxi') || text.includes('spray')) {
                return { type: 'Sint√©tico', bg: 'bg-orange-100', text: 'text-orange-800', border: 'border-orange-200' };
            }
            if (text.includes('acr√≠lica') || text.includes('acrilica') || text.includes('√°gua') || text.includes('agua') || text.includes('m√°rmore')) {
                return { type: 'Al Agua', bg: 'bg-blue-100', text: 'text-blue-700', border: 'border-blue-200' };
            }
            
            return { type: 'General', bg: 'bg-gray-100', text: 'text-gray-600', border: 'border-gray-200' };
        }

        // 4. INICIO Y ESTADO
        let supabaseClient;
        try { supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch (e) { console.error(e); }
        let productosEnPantalla = [];

        async function iniciar() {
            let datosNube = [];
            if(supabaseClient) {
                try {
                    const { data } = await supabaseClient.from('precios').select('*');
                    if(data) datosNube = data;
                } catch(e) {}
            }

            productosEnPantalla = catalogoBase.map(item => {
                const infoExtra = datosNube.find(d => d.id === item.id);
                return {
                    ...item,
                    precio: infoExtra ? infoExtra.precio : item.precio,
                    stock: infoExtra ? infoExtra.stock : 'SI',
                    categoria: classifyProduct(item) // ¬°Aqu√≠ ocurre la magia!
                };
            });

            renderizar();
        }

        // 5. RENDERIZADO (Ahora incluye las etiquetas de clasificaci√≥n)
        function renderizar() {
            const busqueda = document.getElementById('search').value.toLowerCase();
            const filtroCat = document.getElementById('filterCategory').value;
            const grid = document.getElementById('grid');
            const emptyState = document.getElementById('emptyState');
            
            // Filtrado
            const filtrados = productosEnPantalla.filter(p => {
                const coincideTexto = p.nombre.toLowerCase().includes(busqueda) || p.id.includes(busqueda);
                const coincideCat = filtroCat === 'Todos' || p.categoria.type === filtroCat;
                return coincideTexto && coincideCat;
            });

            if (filtrados.length === 0) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            } else {
                emptyState.classList.add('hidden');
            }

            // Construcci√≥n de Tarjetas
            grid.innerHTML = filtrados.map(p => `
                <div class="product-card bg-white rounded-2xl p-4 shadow-sm border border-gray-100 flex flex-col justify-between h-full relative group">
                    
                    <span class="absolute top-4 left-4 bg-gray-100 text-gray-400 text-[10px] px-2 py-0.5 rounded font-mono border border-gray-200 z-10">#${p.id}</span>
                    
                    <div class="absolute top-4 right-4 z-10">
                        <span class="px-2 py-1 text-[10px] font-bold uppercase tracking-wider rounded-md border ${p.categoria.bg} ${p.categoria.text} ${p.categoria.border} shadow-sm">
                            ${p.categoria.type}
                        </span>
                    </div>

                    <div class="relative mb-4 mt-6">
                        <img src="${p.img}" class="h-32 w-full object-contain mx-auto transition-all duration-300 ${p.stock === 'NO' ? 'grayscale opacity-40' : 'group-hover:scale-105'}">
                    </div>
                    
                    <div>
                        <h3 class="font-bold text-gray-800 text-sm leading-tight mb-3 min-h-[40px] line-clamp-2" title="${p.nombre}">${p.nombre}</h3>
                    </div>

                    <div class="mt-auto">
                        <div class="admin-only bg-slate-50 border border-slate-100 p-3 rounded-xl mb-3">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Precio Gs.</label>
                                <input type="number" value="${p.precio}" 
                                    onchange="guardarCambio('${p.id}', 'precio', this.value)"
                                    class="w-24 text-right text-sm font-semibold bg-white border border-gray-200 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Stock</label>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" onchange="guardarCambio('${p.id}', 'stock', this.checked ? 'SI' : 'NO')" ${p.stock === 'SI' ? 'checked' : ''}>
                                    <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>

                        <div class="client-only flex justify-between items-end mb-4 px-1">
                            <div>
                                <span class="text-[10px] text-gray-400 block font-medium">PRECIO CONTADO</span>
                                <span class="text-lg font-black text-gray-900 tracking-tight">Gs. ${(p.precio).toLocaleString('es-PY')}</span>
                            </div>
                            <div class="flex flex-col items-end">
                                <span class="text-[10px] font-bold px-2 py-1 rounded-full flex items-center gap-1 ${p.stock === 'SI' ? 'bg-green-50 text-green-700 border border-green-100' : 'bg-red-50 text-red-700 border border-red-100'}">
                                    <span class="w-1.5 h-1.5 rounded-full ${p.stock === 'SI' ? 'bg-green-500' : 'bg-red-500'}"></span>
                                    ${p.stock === 'SI' ? 'Stock' : 'Agotado'}
                                </span>
                            </div>
                        </div>

                        <a href="https://wa.me/${WHATSAPP}?text=Hola, me interesa: ${p.nombre} (ID: ${p.id}) - Precio: ${p.precio}" 
                           target="_blank"
                           class="client-only group/btn relative flex justify-center items-center w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-xl font-bold text-sm transition-all shadow-blue-200 shadow-lg hover:shadow-xl active:scale-95 ${p.stock === 'NO' ? 'opacity-50 pointer-events-none grayscale' : ''}">
                           <span>${p.stock === 'SI' ? 'Hacer Pedido' : 'Sin Stock'}</span>
                           ${p.stock === 'SI' ? '<svg class="w-4 h-4 ml-2 group-hover/btn:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>' : ''}
                        </a>
                    </div>
                </div>
            `).join('');
        }

        async function guardarCambio(id, campo, valor) {
            // Optimistic UI Update (Actualiza visualmente antes de la red)
            const item = productosEnPantalla.find(p => p.id === id);
            if(item) {
                item[campo] = valor;
                if(campo === 'stock') renderizar();
            }

            // Guardar en Supabase
            if(supabaseClient) {
                const toast = document.getElementById('toast');
                toast.style.opacity = '1';
                toast.style.transform = 'translate(-50%, 0)';
                
                await supabaseClient.from('precios').upsert({ id: id, [campo]: valor });
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translate(-50%, 20px)';
                }, 2000);
            }
        }

        window.activarAdmin = function() {
            const pass = prompt("üîê Acceso Administrativo\nIngrese su PIN:");
            if(pass === "0202") {
                document.body.classList.add('is-admin');
                alert("Modo Editor Activado");
            } else if (pass !== null) {
                alert("PIN Incorrecto");
            }
        }

        // B√∫squeda en tiempo real
        document.getElementById('search').addEventListener('input', renderizar);

        iniciar();
    </script>
</body>
</html>
