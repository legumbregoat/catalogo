<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Catálogo Ciacollor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        
        /* Switch iOS optimizado */
        .toggle-checkbox:checked { right: 0; border-color: #10B981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10B981; }
        
        /* Scroll invisible pero funcional */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Loader */
        .loader {
            border-top-color: #3B82F6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-32 text-slate-800">

    <div id="loader" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
        <h2 class="text-center text-gray-600 text-sm font-semibold">Leyendo CSV...</h2>
        <p id="error-msg" class="text-red-500 text-xs mt-2 hidden text-center px-4"></p>
    </div>

    <div id="app" class="hidden opacity-0 transition-opacity duration-700">
        
        <header class="bg-white/90 backdrop-blur-md border-b border-slate-200 sticky top-0 z-40">
            <div class="max-w-2xl mx-auto px-4 py-3">
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-blue-200">
                            <i class="ph-bold ph-paint-bucket"></i>
                        </div>
                        <div>
                            <h1 class="font-bold text-lg leading-none text-slate-900">Ciacollor</h1>
                            <p class="text-[10px] text-slate-500 font-medium">Panel de Stock</p>
                        </div>
                    </div>
                    <span id="counter" class="text-xs font-mono bg-slate-100 text-slate-600 px-2 py-1 rounded-md border border-slate-200">0</span>
                </div>

                <div class="relative group">
                    <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                    <input type="text" id="search" 
                        class="w-full bg-slate-100/50 border border-slate-200 rounded-xl pl-10 pr-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all placeholder-slate-400"
                        placeholder="Buscar producto, código o uso...">
                </div>

                <div class="flex gap-2 mt-3 overflow-x-auto no-scrollbar pb-1">
                    <button onclick="setFilter('all')" class="filter-chip active px-4 py-1.5 rounded-full text-xs font-bold bg-slate-800 text-white whitespace-nowrap transition-all shadow-sm">Todos</button>
                    <button onclick="setFilter('Emborrachada')" class="filter-chip px-4 py-1.5 rounded-full text-xs font-bold bg-white text-slate-600 border border-slate-200 whitespace-nowrap transition-all hover:border-slate-300">Emborrachada</button>
                    <button onclick="setFilter('Al Agua')" class="filter-chip px-4 py-1.5 rounded-full text-xs font-bold bg-white text-slate-600 border border-slate-200 whitespace-nowrap transition-all hover:border-slate-300">Al Agua</button>
                    <button onclick="setFilter('Sintético')" class="filter-chip px-4 py-1.5 rounded-full text-xs font-bold bg-white text-slate-600 border border-slate-200 whitespace-nowrap transition-all hover:border-slate-300">Sintético</button>
                </div>
            </div>
        </header>

        <main class="max-w-2xl mx-auto px-4 py-6">
            <div id="grid" class="grid grid-cols-1 gap-4">
                </div>
        </main>
    </div>

    <script>
        // URL DEL CSV (Usa timestamp para evitar caché agresivo de GitHub)
        const CSV_URL = 'catalogo.csv?v=' + new Date().getTime();
        
        let products = [];
        let currentFilter = 'all';

        // 1. INICIAR CARGA
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error("No se encontró el archivo catalogo.csv");
                
                // Detectar codificación (Excel a veces usa ISO-8859-1 o UTF-8 con BOM)
                const buffer = await response.arrayBuffer();
                const decoder = new TextDecoder('utf-8');
                const csvText = decoder.decode(buffer);
                
                parseAndRender(csvText);

            } catch (error) {
                document.querySelector('.loader').classList.add('hidden');
                const msg = document.getElementById('error-msg');
                msg.textContent = `Error: ${error.message}. Asegúrate de subir 'catalogo.csv' al mismo lugar que este html.`;
                msg.classList.remove('hidden');
            }
        });

        // 2. PARSEADOR CSV ROBUSTO (Maneja comillas y saltos de línea)
        function parseAndRender(text) {
            // Regex mágica para CSV que respeta comillas dobles internas
            const pattern = /(".*?"|[^",\s]+)(?=\s*,|\s*$)/g; 
            
            // Separar líneas, quitando vacías
            const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
            
            // Empezamos en i=1 para saltar la cabecera
            // Índices basados en tu CSV nuevo:
            // 0:ID, 1:Nombre, 2:Precio, 3:Link, 4:Imagen, 5:Desc, 6:Galeria, 7:Variantes
            
            products = [];

            for (let i = 1; i < lines.length; i++) {
                // Truco: Usar una librería ligera o un split inteligente.
                // Como JS nativo no tiene parser CSV, usamos un split por coma básico 
                // PERO reconstruimos si hay comillas rotas (solución simple para rendimiento)
                
                // Nota: Tu CSV usa comillas para descripciones complejas. Usaré un parser de estado simple.
                const row = parseCSVLine(lines[i]);
                
                if (!row || row.length < 5) continue;

                const id = row[0];
                const name = row[1];
                let price = row[2];
                const image = row[4];
                const desc = row[5];
                const variants = row[7] || "";

                // Lógica de Precio
                if ((!price || price === '0.00' || price === '') && variants) {
                    const match = variants.match(/R\$([\d\.]+)/);
                    if (match) price = match[1];
                }
                
                // Lógica de Stock (Escaneamos variantes buscando 'Stock:SI')
                // Si no hay info, asumimos SI por defecto para no ocultar productos
                const hasStock = variants.includes('Stock:SI') || !variants.includes('Stock:NO');

                // Lógica Categoría
                const fullText = (name + ' ' + desc).toLowerCase();
                let cat = 'Otros';
                if (fullText.includes('ciaflex') || fullText.includes('emborrachada') || fullText.includes('impermeabilizante')) cat = 'Emborrachada';
                else if (fullText.includes('sintético') || fullText.includes('sintetico') || fullText.includes('esmalte') || fullText.includes('solvente')) cat = 'Sintético';
                else if (fullText.includes('acrílica') || fullText.includes('acrilica') || fullText.includes('água') || fullText.includes('agua')) cat = 'Al Agua';

                // Traducción
                const cleanName = name
                    .replace(/Tinta/gi, 'Pintura')
                    .replace(/Fosco/gi, 'Mate')
                    .replace(/Brilhante/gi, 'Brillante')
                    .replace(/Demãos/gi, 'Manos');

                products.push({
                    id, 
                    name: cleanName,
                    price: parseFloat(price) || 0,
                    stock: hasStock,
                    image,
                    cat,
                    searchStr: (id + ' ' + cleanName + ' ' + cat).toLowerCase()
                });
            }

            initApp();
        }

        // Parser línea a línea que respeta comillas ("...")
        function parseCSVLine(text) {
            const result = [];
            let start = 0;
            let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                if (text[i] === '"') { inQuotes = !inQuotes; }
                else if (text[i] === ',' && !inQuotes) {
                    let field = text.substring(start, i);
                    // Quitar comillas envolventes y dobles comillas
                    if (field.startsWith('"') && field.endsWith('"')) {
                        field = field.slice(1, -1).replace(/""/g, '"');
                    }
                    result.push(field.trim());
                    start = i + 1;
                }
            }
            // Último campo
            let lastField = text.substring(start);
            if (lastField.startsWith('"') && lastField.endsWith('"')) {
                lastField = lastField.slice(1, -1).replace(/""/g, '"');
            }
            result.push(lastField.trim());
            return result;
        }

        // 3. RENDERIZADO
        function initApp() {
            document.getElementById('loader').classList.add('hidden');
            const app = document.getElementById('app');
            app.classList.remove('hidden');
            // Timeout para que la transición de opacidad funcione
            setTimeout(() => app.classList.remove('opacity-0'), 50);
            
            updateCounter();
            renderList(products);
        }

        function renderList(items) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            if (items.length === 0) {
                grid.innerHTML = `<div class="text-center py-10 text-slate-400">No hay productos que coincidan.</div>`;
                return;
            }

            const fragment = document.createDocumentFragment();

            items.forEach(p => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex gap-4 transition-transform active:scale-[0.99]';
                
                // Estilo según categoría
                let badgeClass = 'bg-slate-100 text-slate-600';
                if(p.cat === 'Al Agua') badgeClass = 'bg-blue-50 text-blue-600 ring-1 ring-blue-100';
                if(p.cat === 'Sintético') badgeClass = 'bg-orange-50 text-orange-600 ring-1 ring-orange-100';
                if(p.cat === 'Emborrachada') badgeClass = 'bg-teal-50 text-teal-600 ring-1 ring-teal-100';

                card.innerHTML = `
                    <div class="w-24 h-24 bg-slate-50 rounded-xl flex-shrink-0 p-2 flex items-center justify-center relative overflow-hidden">
                        <img src="${p.image}" loading="lazy" class="max-w-full max-h-full object-contain mix-blend-multiply" onerror="this.style.opacity=0.2">
                    </div>
                    
                    <div class="flex-grow flex flex-col justify-between min-w-0">
                        <div>
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-[10px] uppercase font-bold tracking-wider px-2 py-0.5 rounded-full ${badgeClass}">${p.cat}</span>
                                <span class="text-[10px] font-mono text-slate-400">#${p.id}</span>
                            </div>
                            <h3 class="text-sm font-bold text-slate-800 leading-tight line-clamp-2">${p.name}</h3>
                        </div>

                        <div class="flex items-end justify-between mt-2 pt-3 border-t border-slate-50">
                            <div>
                                <label class="text-[9px] uppercase text-slate-400 font-bold block mb-0.5">Precio</label>
                                <div class="flex items-baseline font-bold text-slate-700">
                                    <span class="text-xs mr-0.5">R$</span>
                                    <input type="number" value="${p.price.toFixed(2)}" class="w-20 bg-transparent border-b border-transparent hover:border-slate-300 focus:border-blue-500 focus:outline-none p-0 text-base m-0">
                                </div>
                            </div>

                            <div class="relative inline-block w-11 h-6">
                                <input type="checkbox" id="sw-${p.id}" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 top-0.5 left-0.5 z-10" ${p.stock ? 'checked' : ''}>
                                <label for="sw-${p.id}" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-200 cursor-pointer transition-colors duration-300"></label>
                            </div>
                        </div>
                    </div>
                `;
                fragment.appendChild(card);
            });
            grid.appendChild(fragment);
        }

        // 4. LÓGICA FILTROS Y BÚSQUEDA
        function setFilter(cat) {
            currentFilter = cat;
            document.querySelectorAll('.filter-chip').forEach(btn => {
                // Estilos activo/inactivo
                if( (cat === 'all' && btn.innerText === 'Todos') || btn.innerText === cat ) {
                    btn.className = 'filter-chip active px-4 py-1.5 rounded-full text-xs font-bold bg-slate-800 text-white whitespace-nowrap transition-all shadow-md transform scale-105';
                } else {
                    btn.className = 'filter-chip px-4 py-1.5 rounded-full text-xs font-bold bg-white text-slate-600 border border-slate-200 whitespace-nowrap transition-all hover:bg-slate-50';
                }
            });
            filterItems();
        }

        document.getElementById('search').addEventListener('input', (e) => filterItems(e.target.value));

        function filterItems(searchTerm = document.getElementById('search').value) {
            const term = searchTerm.toLowerCase();
            const filtered = products.filter(p => {
                const matchCat = currentFilter === 'all' || p.cat === currentFilter;
                const matchSearch = p.searchStr.includes(term);
                return matchCat && matchSearch;
            });
            updateCounter(filtered.length);
            renderList(filtered);
        }

        function updateCounter(count = products.length) {
            document.getElementById('counter').innerText = count;
        }

    </script>
</body>
</html>
